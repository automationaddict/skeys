syntax = "proto3";

package skeys.v1;

option go_package = "github.com/automationaddict/skeys-daemon/api/gen/skeys/v1;skeysv1";

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";

service RemoteService {
  rpc ListRemotes(ListRemotesRequest) returns (ListRemotesResponse);
  rpc WatchConnections(WatchConnectionsRequest) returns (stream ListConnectionsResponse);
  rpc GetRemote(GetRemoteRequest) returns (Remote);
  rpc AddRemote(AddRemoteRequest) returns (Remote);
  rpc UpdateRemote(UpdateRemoteRequest) returns (Remote);
  rpc DeleteRemote(DeleteRemoteRequest) returns (google.protobuf.Empty);
  rpc TestConnection(TestRemoteConnectionRequest) returns (TestRemoteConnectionResponse);
  rpc Connect(ConnectRequest) returns (ConnectResponse);
  rpc Disconnect(DisconnectRequest) returns (google.protobuf.Empty);
  rpc ListConnections(ListConnectionsRequest) returns (ListConnectionsResponse);
  rpc ExecuteCommand(ExecuteCommandRequest) returns (ExecuteCommandResponse);
}

message Remote {
  string id = 1;
  string name = 2;
  string host = 3;
  int32 port = 4;
  string user = 5;
  string identity_file = 6;
  string ssh_config_alias = 7;
  google.protobuf.Timestamp created_at = 8;
  google.protobuf.Timestamp last_connected_at = 9;
  RemoteStatus status = 10;
}

enum RemoteStatus {
  REMOTE_STATUS_UNSPECIFIED = 0;
  REMOTE_STATUS_DISCONNECTED = 1;
  REMOTE_STATUS_CONNECTING = 2;
  REMOTE_STATUS_CONNECTED = 3;
  REMOTE_STATUS_ERROR = 4;
}

message Connection {
  string id = 1;
  string remote_id = 2;
  string host = 3;
  int32 port = 4;
  string user = 5;
  string server_version = 6;
  google.protobuf.Timestamp connected_at = 7;
  google.protobuf.Timestamp last_activity_at = 8;
}

message ListRemotesRequest {}

message ListRemotesResponse {
  repeated Remote remotes = 1;
}

message GetRemoteRequest {
  string id = 1;
}

message AddRemoteRequest {
  string name = 1;
  string host = 2;
  int32 port = 3;
  string user = 4;
  string identity_file = 5;
  string ssh_config_alias = 6;
}

message UpdateRemoteRequest {
  string id = 1;
  string name = 2;
  string host = 3;
  int32 port = 4;
  string user = 5;
  string identity_file = 6;
  string ssh_config_alias = 7;
}

message DeleteRemoteRequest {
  string id = 1;
}

message TestRemoteConnectionRequest {
  string remote_id = 1;
  string host = 2;
  int32 port = 3;
  string user = 4;
  string identity_file = 5;
  int32 timeout_seconds = 6;
  string passphrase = 7;  // Passphrase for encrypted key (optional)
  bool trust_host_key = 8;  // If true and host is unknown, add to known_hosts before connecting
}

// Status of host key verification
enum HostKeyStatus {
  HOST_KEY_STATUS_UNSPECIFIED = 0;
  HOST_KEY_STATUS_VERIFIED = 1;     // Host key matched known_hosts
  HOST_KEY_STATUS_UNKNOWN = 2;      // Host not in known_hosts, needs user approval
  HOST_KEY_STATUS_MISMATCH = 3;     // Host key changed (possible MITM attack)
  HOST_KEY_STATUS_ADDED = 4;        // Host key was added to known_hosts (after trust_host_key=true)
}

// Information about an unknown or mismatched host key
message HostKeyInfo {
  string hostname = 1;
  int32 port = 2;
  string key_type = 3;
  string fingerprint = 4;
  string public_key = 5;
}

message TestRemoteConnectionResponse {
  bool success = 1;
  string message = 2;
  string server_version = 3;
  int32 latency_ms = 4;
  HostKeyStatus host_key_status = 5;
  HostKeyInfo host_key_info = 6;  // Present when status is UNKNOWN or MISMATCH
}

message ConnectRequest {
  string remote_id = 1;
  string passphrase = 2;
}

message ConnectResponse {
  Connection connection = 1;
}

message DisconnectRequest {
  string connection_id = 1;
}

message ListConnectionsRequest {}

message WatchConnectionsRequest {}

message ListConnectionsResponse {
  repeated Connection connections = 1;
}

message ExecuteCommandRequest {
  string connection_id = 1;
  string command = 2;
  int32 timeout_seconds = 3;
}

message ExecuteCommandResponse {
  int32 exit_code = 1;
  string stdout = 2;
  string stderr = 3;
}
