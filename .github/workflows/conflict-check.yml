name: Merge Conflict Check

on:
  push:
    branches: [master]
  pull_request_target:
    types: [opened, synchronize]

jobs:
  conflict-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Check for merge conflicts
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Get all open PRs with auto-merge label
            const { data: pullRequests } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
            });

            for (const pr of pullRequests) {
              // Get detailed PR info including mergeable status
              const { data: prDetails } = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: pr.number,
              });

              // GitHub needs time to compute mergeable status
              if (prDetails.mergeable === null) {
                continue;
              }

              if (prDetails.mergeable === false && prDetails.mergeable_state === 'dirty') {
                // Check if we already commented about this conflict
                const { data: comments } = await github.rest.issues.listComments({
                  owner,
                  repo,
                  issue_number: pr.number,
                });

                const conflictComment = comments.find(c =>
                  c.user.type === 'Bot' &&
                  c.body.includes('Merge conflict detected')
                );

                if (!conflictComment) {
                  await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number: pr.number,
                    body: `⚠️ **Merge conflict detected**\n\n@${owner} This PR has conflicts with the base branch that must be resolved before it can be merged.\n\nPlease rebase or merge the latest changes from \`${prDetails.base.ref}\` to resolve the conflicts.`
                  });

                  // Add a label to make it visible
                  await github.rest.issues.addLabels({
                    owner,
                    repo,
                    issue_number: pr.number,
                    labels: ['has-conflicts']
                  });
                }
              }
            }
