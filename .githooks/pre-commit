#!/bin/bash
# Pre-commit hook for code quality checks
set -e

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

errors=0

# =============================================================================
# TOML linting
# =============================================================================
if command -v taplo &> /dev/null; then
    echo "Checking TOML files..."
    if ! taplo check *.toml 2>/dev/null; then
        echo ""
        echo "ERROR: TOML validation failed!"
        echo ""
        echo "  Run: taplo format *.toml"
        echo ""
        errors=1
    else
        echo "TOML files OK"
    fi
else
    echo "WARNING: taplo not installed, skipping TOML check"
fi

# =============================================================================
# YAML linting
# =============================================================================
if command -v yamllint &> /dev/null; then
    echo "Checking YAML files..."
    if ! yamllint -d "{extends: relaxed, rules: {line-length: disable}}" .github/ 2>/dev/null; then
        echo ""
        echo "ERROR: YAML validation failed!"
        echo ""
        errors=1
    else
        echo "YAML files OK"
    fi
else
    echo "WARNING: yamllint not installed, skipping YAML check"
fi

# =============================================================================
# Markdown linting
# =============================================================================
if command -v markdownlint &> /dev/null; then
    echo "Checking Markdown files..."
    # Disabled rules:
    # MD013 - line length
    # MD022 - blanks around headings (too strict for changelogs)
    # MD024 - duplicate headings (changelogs have repeated Added/Changed/etc)
    # MD032 - blanks around lists (too strict)
    # MD033 - inline HTML
    # MD040 - fenced code language (not always needed)
    # MD041 - first line heading
    # MD060 - table column style
    if ! markdownlint --disable MD013 MD022 MD024 MD032 MD033 MD040 MD041 MD060 -- *.md 2>/dev/null; then
        echo ""
        echo "ERROR: Markdown validation failed!"
        echo ""
        errors=1
    else
        echo "Markdown files OK"
    fi
else
    echo "WARNING: markdownlint not installed, skipping Markdown check"
fi

# =============================================================================
# License Headers
# =============================================================================
if command -v addlicense &> /dev/null; then
    echo "Checking license headers..."
    if ! addlicense -check -l mit -c "John Nelson" \
        -ignore "**/*.pb.go" \
        -ignore "**/*.pb.dart" \
        -ignore "**/*.pbjson.dart" \
        -ignore "**/*.pbgrpc.dart" \
        -ignore "**/generated/**" \
        -ignore "skeys-app/lib/core/generated/**" \
        -ignore "skeys-daemon/api/gen/**" \
        skeys-core/**/*.go \
        skeys-daemon/**/*.go \
        skeys-app/lib/**/*.dart \
        2>/dev/null; then
        echo ""
        echo "ERROR: Missing license headers!"
        echo "  Run: addlicense -l mit -c \"John Nelson\" skeys-core skeys-daemon skeys-app/lib"
        echo ""
        errors=1
    else
        echo "License headers OK"
    fi
else
    echo "WARNING: addlicense not installed, skipping license check"
fi

# =============================================================================
# Go formatting (gofmt)
# =============================================================================
if command -v gofmt &> /dev/null; then
    echo "Checking Go formatting..."
    unformatted=$(gofmt -l skeys-core skeys-daemon 2>/dev/null | grep -v ".pb.go" || true)
    if [[ -n "$unformatted" ]]; then
        echo ""
        echo "ERROR: Go files not formatted!"
        echo "$unformatted"
        echo ""
        echo "  Run: gofmt -w skeys-core skeys-daemon"
        echo ""
        errors=1
    else
        echo "Go formatting OK"
    fi
else
    echo "WARNING: gofmt not installed, skipping Go format check"
fi

# =============================================================================
# Go vet
# =============================================================================
if command -v go &> /dev/null; then
    echo "Checking Go vet..."
    vet_failed=0
    for dir in skeys-core skeys-daemon; do
        if [[ -f "$dir/go.mod" ]]; then
            pushd "$dir" > /dev/null
            if ! go vet ./... 2>&1; then
                vet_failed=1
            fi
            popd > /dev/null
        fi
    done
    if [[ $vet_failed -ne 0 ]]; then
        echo ""
        echo "ERROR: Go vet issues found!"
        echo ""
        errors=1
    else
        echo "Go vet OK"
    fi
else
    echo "WARNING: go not installed, skipping Go vet"
fi

# =============================================================================
# Go linting (staticcheck or golangci-lint)
# =============================================================================
if command -v staticcheck &> /dev/null; then
    echo "Checking Go lint (staticcheck)..."
    lint_failed=0
    for dir in skeys-core skeys-daemon; do
        if [[ -f "$dir/go.mod" ]]; then
            pushd "$dir" > /dev/null
            if ! staticcheck ./... 2>/dev/null; then
                lint_failed=1
            fi
            popd > /dev/null
        fi
    done
    if [[ $lint_failed -ne 0 ]]; then
        echo ""
        echo "ERROR: Go lint issues found!"
        echo ""
        errors=1
    else
        echo "Go lint OK"
    fi
elif command -v golangci-lint &> /dev/null; then
    echo "Checking Go lint (golangci-lint)..."
    lint_failed=0
    for dir in skeys-core skeys-daemon; do
        if [[ -f "$dir/go.mod" ]]; then
            pushd "$dir" > /dev/null
            if ! golangci-lint run ./... 2>/dev/null; then
                lint_failed=1
            fi
            popd > /dev/null
        fi
    done
    if [[ $lint_failed -ne 0 ]]; then
        echo ""
        echo "ERROR: Go lint issues found!"
        echo ""
        errors=1
    else
        echo "Go lint OK"
    fi
else
    echo "WARNING: staticcheck/golangci-lint not installed, skipping Go lint"
fi

# =============================================================================
# Go build verification
# =============================================================================
if command -v go &> /dev/null; then
    echo "Checking Go build..."
    build_failed=0
    for dir in skeys-core skeys-daemon; do
        if [[ -f "$dir/go.mod" ]]; then
            pushd "$dir" > /dev/null
            if ! go build ./... 2>&1; then
                build_failed=1
            fi
            popd > /dev/null
        fi
    done
    if [[ $build_failed -ne 0 ]]; then
        echo ""
        echo "ERROR: Go build failed!"
        echo ""
        errors=1
    else
        echo "Go build OK"
    fi
else
    echo "WARNING: go not installed, skipping Go build check"
fi

# =============================================================================
# Go tests
# =============================================================================
if command -v go &> /dev/null; then
    echo "Running Go tests..."
    test_failed=0
    for dir in skeys-core skeys-daemon; do
        if [[ -f "$dir/go.mod" ]]; then
            pushd "$dir" > /dev/null
            if ! go test -short ./... 2>&1; then
                test_failed=1
            fi
            popd > /dev/null
        fi
    done
    if [[ $test_failed -ne 0 ]]; then
        echo ""
        echo "ERROR: Go tests failed!"
        echo ""
        errors=1
    else
        echo "Go tests OK"
    fi
else
    echo "WARNING: go not installed, skipping Go tests"
fi

# =============================================================================
# Dart formatting
# =============================================================================
if command -v dart &> /dev/null; then
    echo "Checking Dart formatting..."
    if ! dart format --set-exit-if-changed --output=none skeys-app/lib 2>/dev/null; then
        echo ""
        echo "ERROR: Dart files not formatted!"
        echo ""
        echo "  Run: dart format skeys-app/lib"
        echo ""
        errors=1
    else
        echo "Dart formatting OK"
    fi
else
    echo "WARNING: dart not installed, skipping Dart format check"
fi

# =============================================================================
# Dart analysis
# =============================================================================
if command -v dart &> /dev/null; then
    echo "Checking Dart analysis..."
    pushd skeys-app > /dev/null
    if ! dart analyze --fatal-infos lib 2>/dev/null; then
        echo ""
        echo "ERROR: Dart analysis issues found!"
        echo ""
        errors=1
    else
        echo "Dart analysis OK"
    fi
    popd > /dev/null
else
    echo "WARNING: dart not installed, skipping Dart analysis"
fi

# =============================================================================
# Flutter build verification
# =============================================================================
if command -v flutter &> /dev/null; then
    echo "Checking Flutter build..."
    pushd skeys-app > /dev/null
    if ! flutter build linux --debug 2>&1 | tail -5; then
        echo ""
        echo "ERROR: Flutter build failed!"
        echo ""
        errors=1
    else
        echo "Flutter build OK"
    fi
    popd > /dev/null
else
    echo "WARNING: flutter not installed, skipping Flutter build check"
fi

# =============================================================================
# Flutter tests
# =============================================================================
if command -v flutter &> /dev/null; then
    echo "Running Flutter tests..."
    pushd skeys-app > /dev/null
    if ! flutter test 2>&1; then
        echo ""
        echo "ERROR: Flutter tests failed!"
        echo ""
        errors=1
    else
        echo "Flutter tests OK"
    fi
    popd > /dev/null
else
    echo "WARNING: flutter not installed, skipping Flutter tests"
fi

# =============================================================================
# Protobuf generation check
# =============================================================================
if command -v protoc &> /dev/null; then
    echo "Checking protobuf generation..."

    # Generate to temp directory and compare
    tmpdir=$(mktemp -d)
    trap "rm -rf $tmpdir" EXIT

    # Check if proto files exist
    if [[ -d "proto" ]]; then
        # Generate Go protos
        if [[ -f "skeys-daemon/api/gen/skeys/v1/agent.pb.go" ]]; then
            protoc --proto_path=proto \
                --go_out="$tmpdir" --go_opt=module=github.com/johnnelson/skeys-daemon/api/gen \
                --go-grpc_out="$tmpdir" --go-grpc_opt=module=github.com/johnnelson/skeys-daemon/api/gen \
                proto/skeys/v1/*.proto 2>/dev/null || true

            # Compare generated files (just check if they would differ)
            if ! diff -rq "$tmpdir/skeys/v1" "skeys-daemon/api/gen/skeys/v1" &>/dev/null 2>&1; then
                echo ""
                echo "WARNING: Generated protobuf files may be out of date"
                echo "  Run: make proto (or your proto generation command)"
                echo ""
                # Don't fail on this, just warn
            else
                echo "Protobuf files OK"
            fi
        else
            echo "Protobuf files OK (skipped - no generated files found)"
        fi
    else
        echo "Protobuf files OK (skipped - no proto directory)"
    fi
else
    echo "WARNING: protoc not installed, skipping protobuf check"
fi

# =============================================================================
# Exit
# =============================================================================
if [[ $errors -ne 0 ]]; then
    echo ""
    echo "Pre-commit checks FAILED"
    exit 1
fi

echo ""
echo "All pre-commit checks passed"
exit 0
